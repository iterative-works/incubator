# Remote TestContainers Configuration for CI Testing

## Problem

Our integration tests use TestContainers to manage PostgreSQL database instances in Docker containers. While this works well locally, we need to extend this functionality to:

1. Run integration tests in CI environments where Docker isn't available locally
2. Support Playwright end-to-end testing with containerized services
3. Ensure consistent test environments across development and CI

The default TestContainers configuration attempts to connect to a local Docker daemon, which won't work in our CI setup or when testing with remote Docker instances.

## Solution

Configure TestContainers to connect to a remote Docker host via TCP with TLS authentication. This involves setting specific configuration parameters through either environment variables, JVM system properties, or a properties file.

## Implementation Details

### 1. Remote Docker Connection Requirements

- TestContainers doesn't support the `ssh://` protocol for remote connections
- Remote Docker must be configured with TCP endpoints and TLS certificates
- Docker context settings are not used by TestContainers

### 2. Configuration Options

#### Option 1: Properties File

Create a `$HOME/.testcontainers.properties` file with the following content:

```properties
testcontainers.docker.host=tcp://193.86.200.14:2376
testcontainers.docker.tls.verify=true
testcontainers.docker.cert.path=/Users/mph/.docker/contexts/tls/c7ccc9baf0d00a8200202d17675e1dd2437985795e149d36ef035c5c9542ae28
```

#### Option 2: JVM System Properties

Pass the following arguments to the JVM:

```
-Dtestcontainers.docker.host=tcp://193.86.200.14:2376
-Dtestcontainers.docker.tls.verify=true
-Dtestcontainers.docker.cert.path=/Users/mph/.docker/contexts/tls/c7ccc9baf0d00a8200202d17675e1dd2437985795e149d36ef035c5c9542ae28
```

#### Option 3: Environment Variables

Set the standard Docker environment variables:

```bash
DOCKER_HOST=tcp://193.86.200.14:2376
DOCKER_TLS_VERIFY=1
DOCKER_CERT_PATH=/Users/mph/.docker/contexts/tls/c7ccc9baf0d00a8200202d17675e1dd2437985795e149d36ef035c5c9542ae28
```

The `DOCKER_CERT_PATH` directory must contain the required certificate files:
- `ca.pem` - Certificate Authority certificate
- `cert.pem` - Client certificate
- `key.pem` - Client private key

### 3. CI Implementation Plan

For our CI workflow, we'll:

1. Store the Docker certificates as encrypted secrets in the CI system
2. Deploy certificates to the appropriate path during job initialization
3. Set environment variables to configure TestContainers
4. Run integration tests and Playwright tests against the remote Docker host

### 4. Developer Workflow

For local development:
1. Configure a local `.testcontainers.properties` file with remote Docker settings
2. Ensure TLS certificates are available in the specified path
3. Run tests normally through SBT, which will connect to the remote Docker instance

## Next Steps

1. Set up the certificate storage and retrieval system in CI
2. Create a sample CI job that demonstrates the remote TestContainers setup
3. Update the test documentation to reflect these changes
4. Configure Playwright tests to run with containerized services

## References

- [TestContainers Documentation](https://www.testcontainers.org/features/configuration/)
- [Docker Engine API](https://docs.docker.com/engine/api/)
- [Docker TLS Configuration](https://docs.docker.com/engine/security/protect-access/)